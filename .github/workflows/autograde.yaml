name: PR Auto Grader

on:
  pull_request:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  grade:
    name: PR Auto Grader
    runs-on: ubuntu-latest

    steps:

      # 1Ô∏è‚É£ Checkout PR code
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Clone Private Grader Repository
      - name: Clone Private Grader
        run: |
          git clone https://x-access-token:${{ secrets.GRADER_REPO_TOKEN }}@github.com/Once-1296/CoC-workshop-test-runner.git grader_repo
          if [ ! -d "grader_repo" ]; then
            echo "‚ùå Failed to clone grader repo"
            exit 1
          fi

      # 3Ô∏è‚É£ Fetch main branch
      - name: Fetch Main Branch
        run: git fetch origin main

      - name: Assemble Workspace
        run: |
          mkdir workspace
          mkdir workspace/student_repo
          cp -r grader_repo/grader workspace/
          cp -r grader_repo/hidden_tests workspace/
          cp -r "${{ github.actor }}_solutions/." workspace/student_repo/

      # 4Ô∏è‚É£ Validate Repository Structure
      - name: Validate Structure
        run: python3 grader_repo/grader/validate_structure.py

      # 5Ô∏è‚É£ Validate Only Allowed Files Modified
      - name: Validate Diff
        run: python3 grader_repo/grader/validate_diff.py

      # 6Ô∏è‚É£ Build Docker Sandbox
      - name: Build Docker Image
        run: docker build -t pr-grader workspace/grader/docker

      # 7Ô∏è‚É£ Run Hidden Tests
      - name: Run Hidden Tests
        run: |
          docker run --rm \
            --memory="256m" \
            --cpus="1.0" \
            -v ${{ github.workspace }}/workspace:/workspace \
            pr-grader

      # 8Ô∏è‚É£ Read Results JSON
      - name: Read Results JSON
        id: results
        run: |
          PASSED=$(jq '.passed' workspace/results.json)
          TOTAL=$(jq '.total' workspace/results.json)
          PERCENTAGE=$(( PASSED * 100 / TOTAL ))

          echo "PASSED=$PASSED" >> $GITHUB_OUTPUT
          echo "TOTAL=$TOTAL" >> $GITHUB_OUTPUT
          echo "PERCENTAGE=$PERCENTAGE" >> $GITHUB_OUTPUT

      # 9Ô∏è‚É£ Get Highest Previous Percentage (Across All PRs for User)
      - name: Check Highest Previous Score
        id: compare
        run: |
          python3 - <<EOF
          import os, requests

          github_id = "${{ github.actor }}"
          current_percentage = int("${{ steps.results.outputs.PERCENTAGE }}")

          headers = {
              "apikey": os.environ["SUPABASE_SERVICE_ROLE"],
              "Authorization": f"Bearer {os.environ['SUPABASE_SERVICE_ROLE']}",
          }

          # Select highest percentage for this user
          response = requests.get(
              os.environ["SUPABASE_URL"] +
              f"?github_id=eq.{github_id}&select=percentage&order=percentage.desc&limit=1",
              headers=headers
          )

          highest_previous = 0

          if response.status_code == 200 and response.json():
              highest_previous = response.json()[0].get("percentage", 0)

          print("Highest Previous:", highest_previous)
          print("Current:", current_percentage)

          should_merge = current_percentage > highest_previous

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"HIGHEST_PREVIOUS={highest_previous}\n")
              f.write(f"SHOULD_MERGE={'true' if should_merge else 'false'}\n")
          EOF
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}

      # üîü Insert New Attempt (Always store attempt history)
      - name: Insert New Score
        run: |
          python3 - <<EOF
          import os, requests, json

          payload = {
              "github_id": "${{ github.actor }}",
              "pr_number": int("${{ github.event.pull_request.number }}"),
              "passed": result["passed"],
              "total": result["total"],
              "details": result["details"]
          }

          headers = {
              "apikey": os.environ["SUPABASE_SERVICE_ROLE"],
              "Authorization": f"Bearer {os.environ['SUPABASE_SERVICE_ROLE']}",
              "Prefer": "resolution=merge-duplicates",
              "Content-Type": "application/json"
          }

          response = requests.post(
              os.environ["SUPABASE_URL"] + "?on_conflict=github_id,pr_number",
              json=payload,
              headers=headers
          )

          if response.status_code not in [200, 201]:
              print("Supabase Error:", response.text)
              raise Exception("Failed to insert score")

          print("‚úÖ Score inserted successfully.")
          EOF
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}

      # 1Ô∏è‚É£1Ô∏è‚É£ Fail If Score Not Improved
      - name: Fail If Score Not Improved
        run: |
          if [ "${{ steps.compare.outputs.SHOULD_MERGE }}" != "true" ]; then
            echo "‚ùå Score not higher than previous best."
            exit 1
          fi

      # 1Ô∏è‚É£2Ô∏è‚É£ Enable Auto Merge if Improved
      - name: Enable Auto Merge
        if: success()
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GRADER_REPO_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: merge
